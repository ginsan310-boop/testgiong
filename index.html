<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªçc VƒÉn B·∫£n Ti·∫øng Vi·ªát (Max 5000 k√Ω t·ª±)</title>
    <style>
        /* GI·ªÆ NGUY√äN GIAO DI·ªÜN ƒê·∫∏P C·ª¶A PHI√äN B·∫¢N TR∆Ø·ªöC */
        body { font-family: 'Segoe UI', sans-serif; background-color: #eef2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background-color: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 90%; max-width: 700px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 1.5rem; }
        .input-wrapper { position: relative; margin-bottom: 1rem; }
        textarea { width: 100%; height: 250px; padding: 15px; padding-bottom: 30px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; resize: vertical; box-sizing: border-box; font-family: inherit; }
        textarea:focus { outline: none; border-color: #3498db; }
        #char-count { position: absolute; bottom: 10px; right: 15px; font-size: 12px; color: #888; font-weight: bold; }
        .limit-reached { color: #e74c3c !important; }
        .controls { display: grid; gap: 20px; margin-bottom: 2rem; background: #f8f9fa; padding: 15px; border-radius: 10px; }
        label { font-weight: 600; font-size: 14px; color: #555; margin-bottom: 5px; display: block; }
        select, input[type="range"] { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        .buttons { display: flex; gap: 15px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.2s; }
        .btn-speak { background-color: #3498db; color: white; }
        .btn-speak:hover { background-color: #2980b9; }
        .btn-pause { background-color: #f1c40f; color: #333; }
        .btn-stop { background-color: #e74c3c; color: white; }
        .speaking textarea { background-color: #fcfcfc; color: #555; }
        
        /* Th√™m th√¥ng b√°o n·∫øu kh√¥ng t√¨m th·∫•y gi·ªçng */
        #voice-warning { color: #c0392b; font-size: 13px; margin-top: 5px; display: none; font-style: italic;}
    </style>
</head>
<body>

<div class="container">
    <h1>Chuy·ªÉn VƒÉn B·∫£n Th√†nh Gi·ªçng N√≥i</h1>
    
    <div class="input-wrapper">
        <textarea id="text-input" maxlength="5000" placeholder="Nh·∫≠p vƒÉn b·∫£n ti·∫øng Vi·ªát v√†o ƒë√¢y (t·ªëi ƒëa 5000 k√Ω t·ª±)..."></textarea>
        <div id="char-count">0 / 5000</div>
    </div>

    <div class="controls">
        <div>
            <label for="voice-select">Ch·ªçn gi·ªçng ƒë·ªçc (∆Øu ti√™n Ti·∫øng Vi·ªát):</label>
            <select id="voice-select"></select>
            <div id="voice-warning">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y gi·ªçng Ti·∫øng Vi·ªát tr√™n m√°y b·∫°n. H√£y th·ª≠ m·ªü b·∫±ng tr√¨nh duy·ªát Edge ho·∫∑c Chrome.</div>
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <label for="rate">T·ªëc ƒë·ªô:</label>
                <input type="range" id="rate" min="0.5" max="2" value="1" step="0.1">
            </div>
            <div style="flex: 1;">
                <label for="pitch">ƒê·ªô cao:</label>
                <input type="range" id="pitch" min="0" max="2" value="1" step="0.1">
            </div>
        </div>
    </div>

    <div class="buttons">
        <button id="speak-btn" class="btn-speak">‚ñ∂ ƒê·ªçc ngay</button>
        <button id="pause-btn" class="btn-pause">II T·∫°m d·ª´ng</button>
        <button id="stop-btn" class="btn-stop">‚ñ† D·ª´ng l·∫°i</button>
    </div>
</div>

<script>
    const synth = window.speechSynthesis;
    const textInput = document.getElementById('text-input');
    const voiceSelect = document.getElementById('voice-select');
    const pitchInput = document.getElementById('pitch');
    const rateInput = document.getElementById('rate');
    const speakBtn = document.getElementById('speak-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const voiceWarning = document.getElementById('voice-warning');

    let voices = [];
    let isPaused = false;

    // C·∫≠p nh·∫≠t b·ªô ƒë·∫øm k√Ω t·ª±
    textInput.addEventListener('input', () => {
        document.getElementById('char-count').textContent = `${textInput.value.length} / 5000`;
    });

    // --- PH·∫¶N QUAN TR·ªåNG: T√åM V√Ä S·∫ÆP X·∫æP GI·ªåNG VI·ªÜT NAM ---
    function populateVoices() {
        // L·∫•y to√†n b·ªô gi·ªçng
        let allVoices = synth.getVoices();
        
        // S·∫Øp x·∫øp: ƒê∆∞a gi·ªçng c√≥ ch·ªØ 'Vietnamese' ho·∫∑c m√£ 'vi-VN' l√™n ƒë·∫ßu danh s√°ch
        allVoices.sort(function (a, b) {
            const aName = a.name.toLowerCase();
            const bName = b.name.toLowerCase();
            const aLang = a.lang.toLowerCase();
            const bLang = b.lang.toLowerCase();

            // Ki·ªÉm tra xem gi·ªçng n√†o l√† ti·∫øng Vi·ªát
            const aIsViet = aLang.includes('vi') || aName.includes('vietnam');
            const bIsViet = bLang.includes('vi') || bName.includes('vietnam');

            if (aIsViet && !bIsViet) return -1; // a l√™n tr∆∞·ªõc
            if (!aIsViet && bIsViet) return 1;  // b l√™n tr∆∞·ªõc
            return 0;
        });

        voices = allVoices;
        voiceSelect.innerHTML = '';
        
        let hasVietnamese = false;

        voices.forEach((voice) => {
            const option = document.createElement('option');
            // Th√™m bi·ªÉu t∆∞·ª£ng c·ªù cho d·ªÖ nh√¨n
            const isViet = voice.lang.includes('vi') || voice.name.toLowerCase().includes('vietnam');
            if (isViet) hasVietnamese = true;
            
            option.textContent = `${isViet ? 'üáªüá≥ ' : ''}${voice.name} (${voice.lang})`;
            option.setAttribute('data-name', voice.name);
            voiceSelect.appendChild(option);
        });

        // C·∫£nh b√°o n·∫øu kh√¥ng c√≥ gi·ªçng Vi·ªát
        if (!hasVietnamese && voices.length > 0) {
            voiceWarning.style.display = 'block';
        } else {
            voiceWarning.style.display = 'none';
            // T·ª± ƒë·ªông ch·ªçn gi·ªçng ƒë·∫ßu ti√™n (ƒë√£ ƒë∆∞·ª£c sort l√† ti·∫øng Vi·ªát)
            voiceSelect.selectedIndex = 0;
        }
    }

    populateVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
    }

    // --- LOGIC ƒê·ªåC VƒÇN B·∫¢N (Chunking 5000 t·ª´) ---
    function splitText(text) {
        // T√°ch c√¢u th√¥ng minh ƒë·ªÉ kh√¥ng b·ªã ng·∫Øt gi·ªØa ch·ª´ng
        return text.match(/[^.!?\n]+[.!?\n]*/g) || [text];
    }

    function speak() {
        if (synth.speaking && isPaused) {
            synth.resume();
            isPaused = false;
            speakBtn.textContent = "‚ñ∂ ƒêang ƒë·ªçc...";
            return;
        }
        
        if (synth.speaking) synth.cancel();

        if (textInput.value !== '') {
            const selectedVoiceName = voiceSelect.selectedOptions[0].getAttribute('data-name');
            const selectedVoice = voices.find(v => v.name === selectedVoiceName);

            // C·∫£nh b√°o n·∫øu ng∆∞·ªùi d√πng c·ªë t√¨nh ch·ªçn gi·ªçng Anh ƒë·ªÉ ƒë·ªçc ti·∫øng Vi·ªát
            if (!selectedVoice.lang.includes('vi') && !selectedVoice.name.toLowerCase().includes('vietnam')) {
                // Kh√¥ng ch·∫∑n, nh∆∞ng gi·ªçng s·∫Ω b·ªã l∆° l·ªõ
            }

            const textChunks = splitText(textInput.value);
            
            textChunks.forEach((chunk, index) => {
                if (!chunk.trim()) return;
                const utterance = new SpeechSynthesisUtterance(chunk);
                utterance.voice = selectedVoice;
                utterance.rate = rateInput.value;
                utterance.pitch = pitchInput.value;
                
                // Fix l·ªói ng·∫Øt ti·∫øng tr√™n Chrome khi ƒë·ªçc c√¢u qu√° d√†i
                utterance.onend = () => { if(index === textChunks.length -1) speakBtn.textContent = "‚ñ∂ ƒê·ªçc ngay"; };
                
                synth.speak(utterance);
            });
            
            speakBtn.textContent = "‚ñ∂ ƒêang ƒë·ªçc...";
        }
    }

    speakBtn.addEventListener('click', speak);
    
    pauseBtn.addEventListener('click', () => {
        if (synth.speaking && !isPaused) {
            synth.pause();
            isPaused = true;
            pauseBtn.textContent = "‚ñ∂ Ti·∫øp t·ª•c";
        } else {
            synth.resume();
            isPaused = false;
            pauseBtn.textContent = "II T·∫°m d·ª´ng";
        }
    });

    stopBtn.addEventListener('click', () => {
        synth.cancel();
        speakBtn.textContent = "‚ñ∂ ƒê·ªçc ngay";
    });
    
    // D·ª´ng khi ƒë√≥ng trang
    window.onbeforeunload = () => synth.cancel();
</script>

</body>
</html>
